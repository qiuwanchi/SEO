<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>SEO - 后台管理系统</title>
	<!-- bootstrap 3.0.2 -->
	<link href="/resource/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
	<!-- font Awesome -->
	<link href="/resource/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
	<!-- iCheck for checkboxes and radio inputs -->
	<link href="/resource/css/iCheck/all.css" rel="stylesheet" type="text/css" />
	<!-- Theme style -->
	<link href="/resource/css/style.css" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" type="text/css" href="/resource/js/webuploader-0.1.5/webuploader.css">
	<link rel="stylesheet" type="text/css" href="/resource/js/jQueryMessage/css/message.skin.css" />

	<script type="text/javascript" charset="utf-8" src="/ueditor/ueditor.config.js"></script>
	<script type="text/javascript" charset="utf-8" src="/ueditor/ueditor.all.js"> </script>
	<!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
	<!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
	<script type="text/javascript" charset="utf-8" src="/ueditor/lang/zh-cn/zh-cn.js"></script>

	<style type="text/css">
        div .ttt{
            width:100%;
        }
    </style>
</head>

<body>
<div class="row">
	<div class="col-md-12">
		<h1 class="panel-heading"></h1>
		<!--breadcrumbs start -->
		<ul class="breadcrumb">
			<li><a href="/admin/dashboard/toIndex"><i class="fa fa-home"></i> 首页</a></li>
			<li><a th:href="@{/firstPage/module(belong=1)}" th:text="${module.name}"><i class="fa fa-home"></i> </a></li>
			<li class="active">编辑项目</li>
		</ul>
		<!--breadcrumbs end -->
	</div>
</div>
<section class="panel">

	<div class="panel-body table-responsive">
		<div class="alert alert-block alert-danger">
			<strong>注意!</strong> 上传成功后切记点击确定按钮，否则不会保存！
		</div>
		<form class="col s12" id="form1" th:action="@{/firstPage/module/project/save}" method="post">
			<input name="attachment.filename" id="filename" type="hidden" th:value="${project.attachment.filename}"/>
			<input name="attachment.filepath" id="filepath" type="hidden" th:value="${project.attachment.filepath}"/>
			<input name="attachment.filetype" id="filetype" type="hidden" th:value="${project.attachment.filetype}"/>
			<input name="attachment.filesize" id="filesize" type="hidden" th:value="${project.attachment.filesize}"/>
			<input name="moduleId" id="moduleId" type="hidden" th:value="${module.id}"/>
			<input name="id" id="id" type="hidden" th:value="${project.id}"/>
			<input name="content" id="content" type="hidden"  th:value="${project.content}"/>
			<input name="attachmentid" id="attachmentid" type="hidden" th:value="${project.attachment.id}"/>
			<div id="uploader" class="wu-example">
				<div class="btns">
					<div id="picker">选择图片或视频...</div>
				</div>
			</div>
			<div class="wu-example">
				图片或者视频的跳转链接(需要填写全路径,如:www.baidu.com/a,没有就不跳转)：<input name="clickUrl" id="clickUrl" th:value="${project.clickUrl}"/>
			</div>
			<div class="wu-example">
				排序号：<input name="sort" id="sort"  th:value="${project.sort}"/>
			</div>
			<div class="wu-example">
				名称：<input name="name" id="name"  th:value="${project.name}"/>
			</div>
			<div class="wu-example">
				描述：<textarea name="describe" id="describe"  th:value="${project.describe}"></textarea>
			</div>
			<div class="wu-example">
				title：<input name="title" id="title" th:value="${project.title}"/>
			</div>
			<div class="wu-example">
				keywords(请用英文逗号分开各个关键字)：<input name="keywords" id="keywords" th:value="${project.keywords}"/>
			</div>
			<div class="wu-example">
				description：<input name="description" id="description" th:value="${project.description}"/>
			</div>
			<div class="wu-example">
				alt：<input name="alt" id="alt" th:value="${project.alt}"/>
			</div>

		</form>
	</div>

	<h1>正文内容：</h1>
	<div class="ttt">
		<script id="editor" type="text/plain" style="width:1024px;height:500px;"></script>
	</div>

	<div class="modal-footer">
		<button type="button" class="btn btn-primary btn-addon btn-sm" onclick="save();">保存</button>
	</div>
</section>

<!-- jQuery 2.0.2 -->
<script src="/resource/js/jquery.min.js" type="text/javascript"></script>
<!-- Bootstrap -->
<script src="/resource/js/bootstrap.min.js" type="text/javascript"></script>
<!-- iCheck -->
<script src="/resource/js/plugins/iCheck/icheck.min.js" type="text/javascript"></script>
<script type="text/javascript" src="/resource/js/webuploader-0.1.5/webuploader.js"></script>
<script type="text/javascript" src="/resource/js/jQueryMessage/js/jquery.plugin.message.js"></script>
<script src="/resource/js/clipboard.min.js" type="text/javascript"></script>
<script type="text/javascript" th:inline="javascript">
	var system = [[${system}]];
	function initUploader(picker,inputEl){
    	var uploader = WebUploader.create({
    		auto: true,
	        // swf文件路径
	        swf: '/resource/js/webuploader-0.1.5/Uploader.swf',
	        // 文件接收服务端。
	        server: '/upload/uploadFile',
	        // 选择文件的按钮。可选。
	        compress: false,
	        // 内部根据当前运行是创建，可能是input元素，也可能是flash.
	        pick: '#' + picker,
	        fileNumLimit: 1,
	        // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！
	        resize: false
	    });
    	uploader.on('fileQueued', function(file) {

    	});
	    uploader.on('uploadSuccess', function(file, response) {
	    	console.log(response);
	    	$("body").MessageBox({
				type: 'success',
				message: '上传成功！',
				timeout:3000,
				callbak:null
			});
	    	$("#filename").val(response.data.originalFilename);
	    	$("#filepath").val(response.data.filepath);
	    	$("#filesize").val(response.data.filesize);
	    	$("#filetype").val(response.data.filetype);
	    });
	    uploader.on('uploadError', function( file ) {
	    	$("body").MessageBox({
				type: 'error',
				message: '上传失败！',
				timeout:3000,
				callbak:null
			});
	    });
    }

    $(document).ready(function () {
    	initUploader("picker","fileUpload");
	    renderCheckBox();
    });

	function renderCheckBox(){
		$('input').on('ifChecked', function(event) {
		    $(this).parents('li').addClass("task-done");
		    console.log('ok');
		});
		$('input').on('ifUnchecked', function(event) {
		    $(this).parents('li').removeClass("task-done");
		    console.log('not');
		});

		$('input[type="checkbox"].flat-grey, input[type="radio"].flat-grey').iCheck({
		    checkboxClass: 'icheckbox_flat-grey',
		    radioClass: 'iradio_flat-grey'
		});
	}

	function openUploadDialog(){
		$("#upload-dialog").modal();
	}

	function openUploadDialogForUpdate(id){
		$.ajax({
			type: 'get',
			url: "/firstPage/module/project/getById?projectId=" + id,
			contentType: 'application/json',
			async: false,
			success: function(project) {
				$("#id").val(id);

				if(!isEmpty(project.attachment)){
					$("#filename").val(project.attachment.filename);
					$("#filepath").val(project.attachment.filepath);
					$("#filesize").val(project.attachment.filesize);
					$("#filetype").val(project.attachment.filetype);
					$("#attachmentid").val(project.attachment.id);
				}

				if(!isEmpty(project.name)){
					$("#name").val(project.name);
				}

				if(!isEmpty(project.describe)){
					$("#describe").val(project.describe);
				}

				if(!isEmpty(project.sort)){
					$("#sort").val(project.sort);
				}

				if(!isEmpty(project.title)){
					$("#title").val(project.title);
				}

				if(!isEmpty(project.keywords)){
					$("#keywords").val(project.keywords);
				}

				if(!isEmpty(project.description)){
					$("#description").val(project.description);
				}

				if(!isEmpty(project.alt)){
					$("#alt").val(project.alt);
				}

				if(!isEmpty(project.clickUrl)){
					$("#clickUrl").val(project.clickUrl);
				}

				$("#aaa").html("编辑");
			}
		});

		$("#upload-dialog").modal();
	}

	function isEmpty(obj) {
		if (obj == null || obj == "" || obj == "undefined") {
			return true;
		}
		return false;
    }

	function save(){
		var filepath = $("#filepath").val();
		if(isEmpty(filepath)){
			$("body").MessageBox({
				type: 'error',
				message: '请选择图片或视频！',
				timeout:5000,
				callbak:null
			});
			return;
		}

		var name = $("#name").val();
		if(isEmpty(name)){
			$("body").MessageBox({
				type: 'error',
				message: '请填写名称！',
				timeout:5000,
				callbak:null
			});
			return;
		}

		var sort = $("#sort").val();
		if(isEmpty(sort)){
			$("body").MessageBox({
				type: 'error',
				message: '排序不能为空！',
				timeout:5000,
				callbak:null
			});
			return;
		}

		var posPattern = /^\d+$/;
		if(!posPattern.test(sort)){
			$("body").MessageBox({
				type: 'error',
				message: '排序必须为数字，并且必须大于0！',
				timeout:5000,
				callbak:null
			});
			return;
		}

		var content = UE.getEditor('editor').getContent();
		$("#content").val(html_encode(content));
		$("#form1").submit();
	}

 // 编码
  function html_encode(str)
  {
    	var s = '';
		if(str.length === 0) {
			return '';
		}
		s = str.replace(/&/g,'&amp;');
		s = s.replace(/</g,'&lt;');
		s = s.replace(/>/g,'&gt;');
		s = s.replace(/ /g,'&nbsp;');
		s = s.replace(/\'/g,'&#39;');
		s= s.replace(/\"/g,'&quot;');
		return s;
  }

  	// 解码
  function html_decode(str)
  {
    	var s = '';
		if(str.length === 0) {
			return '';
		}
		s = str.replace(/&amp;/g, '&');
		s = s.replace(/&lt;/g,'<');
		s = s.replace(/&gt;/g,'>');
		s = s.replace(/&nbsp;/g,' ');
		s = s.replace(/&#39;/g,'\'');
		s = s.replace(/&quot;/g,'\"');

		s = str.replace(/＆amp;/g, '&');
		s = s.replace(/＆lt;/g,'<');
		s = s.replace(/＆gt;/g,'>');
		s = s.replace(/＆nbsp;/g,' ');
		s = s.replace(/＆#39;/g,'\'');
		s = s.replace(/＆quot;/g,'\"');

		return s;
  }


//实例化编辑器
    //建议使用工厂方法getEditor创建和引用编辑器实例，如果在某个闭包下引用该编辑器，直接调用UE.getEditor('editor')就能拿到相关的实例
    var ue = UE.getEditor('editor');


    function isFocus(e){
        alert(UE.getEditor('editor').isFocus());
        UE.dom.domUtils.preventDefault(e)
    }
    function setblur(e){
        UE.getEditor('editor').blur();
        UE.dom.domUtils.preventDefault(e)
    }
    function insertHtml() {
        var value = prompt('插入html代码', '');
        UE.getEditor('editor').execCommand('insertHtml', value)
    }
    function createEditor() {
        enableBtn();
        UE.getEditor('editor');
    }
    function getAllHtml() {
        alert(UE.getEditor('editor').getAllHtml())
    }
    function getContent() {
        var arr = [];
        arr.push("使用editor.getContent()方法可以获得编辑器的内容");
        arr.push("内容为：");
        arr.push(UE.getEditor('editor').getContent());
        alert(arr.join("\n"));
    }
    function getPlainTxt() {
        var arr = [];
        arr.push("使用editor.getPlainTxt()方法可以获得编辑器的带格式的纯文本内容");
        arr.push("内容为：");
        arr.push(UE.getEditor('editor').getPlainTxt());
        alert(arr.join('\n'))
    }
    function setContent(isAppendTo) {
        var arr = [];
        arr.push("使用editor.setContent('欢迎使用ueditor')方法可以设置编辑器的内容");
        UE.getEditor('editor').setContent('欢迎使用ueditor', isAppendTo);
        alert(arr.join("\n"));
    }
    function setDisabled() {
        UE.getEditor('editor').setDisabled('fullscreen');
        disableBtn("enable");
    }

    function setEnabled() {
        UE.getEditor('editor').setEnabled();
        enableBtn();
    }

    function getText() {
        //当你点击按钮时编辑区域已经失去了焦点，如果直接用getText将不会得到内容，所以要在选回来，然后取得内容
        var range = UE.getEditor('editor').selection.getRange();
        range.select();
        var txt = UE.getEditor('editor').selection.getText();
        alert(txt)
    }

    function getContentTxt() {
        var arr = [];
        arr.push("使用editor.getContentTxt()方法可以获得编辑器的纯文本内容");
        arr.push("编辑器的纯文本内容为：");
        arr.push(UE.getEditor('editor').getContentTxt());
        alert(arr.join("\n"));
    }
    function hasContent() {
        var arr = [];
        arr.push("使用editor.hasContents()方法判断编辑器里是否有内容");
        arr.push("判断结果为：");
        arr.push(UE.getEditor('editor').hasContents());
        alert(arr.join("\n"));
    }
    function setFocus() {
        UE.getEditor('editor').focus();
    }
    function deleteEditor() {
        disableBtn();
        UE.getEditor('editor').destroy();
    }
    function disableBtn(str) {
        var div = document.getElementById('btns');
        var btns = UE.dom.domUtils.getElementsByTagName(div, "button");
        for (var i = 0, btn; btn = btns[i++];) {
            if (btn.id == str) {
                UE.dom.domUtils.removeAttributes(btn, ["disabled"]);
            } else {
                btn.setAttribute("disabled", "true");
            }
        }
    }
    function enableBtn() {
        var div = document.getElementById('btns');
        var btns = UE.dom.domUtils.getElementsByTagName(div, "button");
        for (var i = 0, btn; btn = btns[i++];) {
            UE.dom.domUtils.removeAttributes(btn, ["disabled"]);
        }
    }

    function getLocalData () {
        alert(UE.getEditor('editor').execCommand( "getlocaldata" ));
    }

    function clearLocalData () {
        UE.getEditor('editor').execCommand( "clearlocaldata" );
        alert("已清空草稿箱")
    }

    var t1 = window.setTimeout(function t(){
    	var content = $("#content").val();
    	content = html_decode(content);
    	var obj = UE.getEditor('editor');
		if(obj){
    		obj.setContent(content);
    		window.clearTimeout(t1);
    	}

    }, 5000)



</script>
</body>
</html>

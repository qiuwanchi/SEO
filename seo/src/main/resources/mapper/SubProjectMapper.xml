<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qiuwanchi.seo.mapper.SubProjectMapper">

    <select id="getProjectListByProjectId" resultType="com.qiuwanchi.seo.dto.SubProjectDto">
        SELECT
            b.id,
            b.number,
            b.name,
            b.describe_msg AS describeMsg,
            b.project_id AS projectId,
            b.attachment_id AS attachmentId,
            b.sort,
            b.title,
            b.keywords,
            b.description,
            b.alt,
            b.banner_id AS bannerId,
            b.content,
            b.click_url AS clickUrl,
            b.create_by AS createBy,
            b.create_time AS createTime,
            b.update_by AS updateBy,
            b.update_time AS updateTime,
            a.filename AS fileName,
            a.filesize AS fileSize,
            a.filetype AS fileType,
            a.filepath AS filePath,
            a.file_id AS fileId
        FROM sub_project b LEFT JOIN system_attachment a ON b.attachment_id=a.id WHERE b.project_id=#{projectId}
        ORDER BY b.sort
    </select>

    <select id="getProjectListByProjectIds" resultType="com.qiuwanchi.seo.dto.SubProjectDto">
        SELECT
            b.id,
            b.number,
            b.name,
            b.describe_msg AS describeMsg,
            b.project_id AS projectId,
            b.attachment_id AS attachmentId,
            b.sort,
            b.title,
            b.keywords,
            b.description,
            b.alt,
            b.banner_id AS bannerId,
            b.click_url AS clickUrl,
            b.create_by AS createBy,
            b.create_time AS createTime,
            b.update_by AS updateBy,
            b.update_time AS updateTime,
            a.filename AS fileName,
            a.filesize AS fileSize,
            a.filetype AS fileType,
            a.filepath AS filePath,
            a.file_id AS fileId
        FROM sub_project b LEFT JOIN system_attachment a ON b.attachment_id=a.id WHERE b.project_id in
        <foreach item="item" index="index" collection="moduleIds" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="getProjectPageListByProjectId" resultType="com.qiuwanchi.seo.dto.SubProjectDto">
        SELECT
        b.id,
        b.number,
        b.name,
        b.describe_msg AS describeMsg,
        b.project_id AS projectId,
        b.attachment_id AS attachmentId,
        b.sort,
        b.title,
        b.keywords,
        b.description,
        b.alt,
        b.banner_id AS bannerId,
        b.click_url AS clickUrl,
        b.create_by AS createBy,
        b.create_time AS createTime,
        b.update_by AS updateBy,
        b.update_time AS updateTime,
        a.filename AS fileName,
        a.filesize AS fileSize,
        a.filetype AS fileType,
        a.filepath AS filePath,
        a.file_id AS fileId
        FROM sub_project b LEFT JOIN system_attachment a ON b.attachment_id=a.id WHERE b.project_id=#{projectId}
        ORDER BY b.sort
    </select>

    <!-- 推荐 -->
    <select id="recommend" resultType="com.qiuwanchi.seo.dto.SubProjectDto">
        SELECT
        b.id,
        b.number,
        b.name,
        b.describe_msg AS describeMsg,
        b.project_id AS projectId,
        b.attachment_id AS attachmentId,
        b.sort,
        b.title,
        b.keywords,
        b.description,
        b.alt,
        b.banner_id AS bannerId,
        b.click_url AS clickUrl,
        b.create_by AS createBy,
        b.create_time AS createTime,
        b.update_by AS updateBy,
        b.update_time AS updateTime,
        p.code AS secondCategory,
        m.code AS firstCategory
        FROM sub_project b LEFT JOIN project p ON b.project_id=p.id
        LEFT JOIN module m ON p.module_id=m.id AND m.belong='ServiceCase'
        WHERE  b.id !=#{subProjectId} AND
        (
        1=0
        <foreach item="item" index="index" collection="keywordsList" open="" separator=" " close="">
            OR b.keywords LIKE "%${item}%"
        </foreach>

        )
        ORDER BY RAND()
        LIMIT 6
    </select>

    <select id="selectPageAll" resultType="com.qiuwanchi.seo.dto.SubProjectDto">
        SELECT
        b.id,
        b.number,
        b.name,
        b.describe_msg AS describeMsg,
        b.project_id AS projectId,
        b.attachment_id AS attachmentId,
        b.sort,
        b.title,
        b.keywords,
        b.description,
        b.alt,
        b.banner_id AS bannerId,
        b.click_url AS clickUrl,
        b.create_by AS createBy,
        b.create_time AS createTime,
        b.update_by AS updateBy,
        b.update_time AS updateTime,
        p.code AS secondCategory,
        m.code AS firstCategory,
        a.filename AS fileName,
        a.filesize AS fileSize,
        a.filetype AS fileType,
        a.filepath AS filePath,
        a.file_id AS fileId
        FROM sub_project b LEFT JOIN project p ON b.project_id=p.id LEFT JOIN module m ON p.module_id=m.id LEFT JOIN system_attachment a ON b.attachment_id=a.id WHERE b.project_id IN (
            SELECT p.id FROM project p JOIN module m ON m.id=p.module_id WHERE m.belong='ServiceCase'
        )
        ORDER BY b.update_time DESC
    </select>

    <select id="selectPageByFirstCategory" resultType="com.qiuwanchi.seo.dto.SubProjectDto">
        SELECT
        b.id,
        b.number,
        b.name,
        b.describe_msg AS describeMsg,
        b.project_id AS projectId,
        b.attachment_id AS attachmentId,
        b.sort,
        b.title,
        b.keywords,
        b.description,
        b.alt,
        b.banner_id AS bannerId,
        b.click_url AS clickUrl,
        b.create_by AS createBy,
        b.create_time AS createTime,
        b.update_by AS updateBy,
        b.update_time AS updateTime,
        p.code AS secondCategory,
        m.code AS firstCategory,
        a.filename AS fileName,
        a.filesize AS fileSize,
        a.filetype AS fileType,
        a.filepath AS filePath,
        a.file_id AS fileId
        FROM sub_project b LEFT JOIN project p ON b.project_id=p.id LEFT JOIN module m ON p.module_id=m.id LEFT JOIN system_attachment a ON b.attachment_id=a.id WHERE b.project_id IN (
            SELECT p.id FROM project p JOIN module m ON m.id=p.module_id WHERE m.belong='ServiceCase' AND m.code=#{firstCategory}
        )
        ORDER BY b.update_time DESC
    </select>

    <select id="selectPageBySecondCategory" resultType="com.qiuwanchi.seo.dto.SubProjectDto">
        SELECT
        b.id,
        b.number,
        b.name,
        b.describe_msg AS describeMsg,
        b.project_id AS projectId,
        b.attachment_id AS attachmentId,
        b.sort,
        b.title,
        b.keywords,
        b.description,
        b.alt,
        b.banner_id AS bannerId,
        b.click_url AS clickUrl,
        b.create_by AS createBy,
        b.create_time AS createTime,
        b.update_by AS updateBy,
        b.update_time AS updateTime,
        p.code AS secondCategory,
        m.code AS firstCategory,
        a.filename AS fileName,
        a.filesize AS fileSize,
        a.filetype AS fileType,
        a.filepath AS filePath,
        a.file_id AS fileId
        FROM sub_project b LEFT JOIN project p ON b.project_id=p.id LEFT JOIN module m ON p.module_id=m.id LEFT JOIN system_attachment a ON b.attachment_id=a.id WHERE b.project_id IN (
        SELECT p.id FROM project p JOIN module m ON m.id=p.module_id WHERE m.belong='ServiceCase' AND m.code=#{firstCategory} AND p.code=#{secondCategory}
        )
        ORDER BY b.update_time DESC
    </select>


    <select id="selectByNumber" resultType="com.qiuwanchi.seo.dto.SubProjectDto">
        SELECT
        b.id,
        b.number,
        b.name,
        b.describe_msg AS describeMsg,
        b.project_id AS projectId,
        b.attachment_id AS attachmentId,
        b.sort,
        b.title,
        b.keywords,
        b.description,
        b.alt,
        b.banner_id AS bannerId,
        b.click_url AS clickUrl,
        b.content,
        b.create_by AS createBy,
        b.create_time AS createTime,
        b.update_by AS updateBy,
        b.update_time AS updateTime,
        p.code AS secondCategory,
        m.code AS firstCategory,
        a.filename AS fileName,
        a.filesize AS fileSize,
        a.filetype AS fileType,
        a.filepath AS filePath,
        a.file_id AS fileId
        FROM sub_project b LEFT JOIN project p ON b.project_id=p.id LEFT JOIN module m ON p.module_id=m.id LEFT JOIN system_attachment a ON b.attachment_id=a.id WHERE b.number=${number}
        ORDER BY b.update_time DESC
    </select>

    <select id="getPreSubProject" resultType="com.qiuwanchi.seo.dto.SubProjectDto">
        SELECT
        b.id,
        b.number,
        b.name,
        b.describe_msg AS describeMsg,
        b.project_id AS projectId,
        b.attachment_id AS attachmentId,
        b.sort,
        b.title,
        b.keywords,
        b.description,
        b.alt,
        b.banner_id AS bannerId,
        b.click_url AS clickUrl,
        b.create_by AS createBy,
        b.create_time AS createTime,
        b.update_by AS updateBy,
        b.update_time AS updateTime,
        p.code AS secondCategory,
        m.code AS firstCategory,
        a.filename AS fileName,
        a.filesize AS fileSize,
        a.filetype AS fileType,
        a.filepath AS filePath,
        a.file_id AS fileId
        FROM sub_project b LEFT JOIN project p ON b.project_id=p.id LEFT JOIN module m ON p.module_id=m.id LEFT JOIN system_attachment a ON b.attachment_id=a.id
        WHERE b.project_id=#{projectId}
        AND b.id !=#{currentSubProjectId}
        AND b.sort  <![CDATA[ <= ]]> #{sort}
        ORDER BY b.sort DESC limit 1
    </select>

    <select id="getNextSubProject" resultType="com.qiuwanchi.seo.dto.SubProjectDto">
        SELECT
        b.id,
        b.number,
        b.name,
        b.describe_msg AS describeMsg,
        b.project_id AS projectId,
        b.attachment_id AS attachmentId,
        b.sort,
        b.title,
        b.keywords,
        b.description,
        b.alt,
        b.banner_id AS bannerId,
        b.click_url AS clickUrl,
        b.create_by AS createBy,
        b.create_time AS createTime,
        b.update_by AS updateBy,
        b.update_time AS updateTime,
        p.code AS secondCategory,
        m.code AS firstCategory,
        a.filename AS fileName,
        a.filesize AS fileSize,
        a.filetype AS fileType,
        a.filepath AS filePath,
        a.file_id AS fileId
        FROM sub_project b LEFT JOIN project p ON b.project_id=p.id LEFT JOIN module m ON p.module_id=m.id LEFT JOIN system_attachment a ON b.attachment_id=a.id
        WHERE b.project_id=#{projectId}
        AND b.id !=#{currentSubProjectId}
        AND b.sort <![CDATA[ >= ]]> #{sort}
        ORDER BY b.sort limit 1
    </select>


    <select id="getSubProjectListByModuleIds" resultType="com.qiuwanchi.seo.dto.SubProjectDto">

        <foreach item="item" index="index" collection="moduleIds" open="" separator="" close="">
        <if test="index !=0" >
            UNION ALL
        </if>
            SELECT * FROM (
            SELECT
                b.id,
                b.number,
                b.name,
                b.describe_msg AS describeMsg,
                b.project_id AS projectId,
                b.attachment_id AS attachmentId,
                b.sort,
                b.title,
                b.keywords,
                b.description,
                b.alt,
                b.banner_id AS bannerId,
                b.click_url AS clickUrl,
                b.create_by AS createBy,
                b.create_time AS createTime,
                b.update_by AS updateBy,
                b.update_time AS updateTime,
                p.code AS secondCategory,
                m.code AS firstCategory,
                a.filename AS fileName,
                a.filesize AS fileSize,
                a.filetype AS fileType,
                a.filepath AS filePath,
                a.file_id AS fileId,
                m.id AS moduleId
                FROM sub_project b JOIN project p ON b.project_id=p.id JOIN module m ON p.module_id=m.id LEFT JOIN system_attachment a ON b.attachment_id=a.id
                WHERE m.id=#{item}
                <if test="homePageDisplay !=null" >
                    AND b.home_page_display=#{homePageDisplay}
                    AND p.home_page_display=#{homePageDisplay}
                </if>

                ORDER BY b.sort

                <if test="pageSize !=null" >
                    limit #{pageSize}
                </if>

            ) t${index}
        </foreach>
    </select>



    <select id="getRecommendServiceCaseSubProjectList" resultType="com.qiuwanchi.seo.dto.SubProjectDto">
        SELECT
        s.id,
        s.number,
        s.name,
        s.describe_msg AS describeMsg,
        s.attachment_id AS attachmentId,
        s.sort,
        s.title,
        s.keywords,
        s.description,
        s.alt,
        s.banner_id AS bannerId,
        s.click_url AS clickUrl,
        s.create_by AS createBy,
        s.create_time AS createTime,
        s.update_by AS updateBy,
        s.update_time AS updateTime,
        a.filename AS fileName,
        a.filesize AS fileSize,
        a.filetype AS fileType,
        a.filepath AS filePath,
        a.file_id AS fileId,
        m.code AS firstCategory,
        p.code AS secondCategory
        FROM seo_video v JOIN sub_project s ON v.belong_id=s.id
        JOIN project p ON s.project_id=p.id
        JOIN module m ON p.module_id=m.id
        LEFT JOIN system_attachment a ON s.attachment_id=a.id
        WHERE m.belong='ServiceCase'
        AND m.code=#{firstCategory}
        ORDER BY RAND() LIMIT 8
    </select>

    <select id="selectServiceCaseKeywordsList" resultType="java.lang.String">
        SELECT s.keywords
        FROM sub_project s
        JOIN project p ON s.project_id=p.id
        JOIN module m ON p.module_id=m.id
        WHERE m.belong='ServiceCase' AND s.keywords IS NOT NULL AND s.keywords !='';
    </select>


    <select id="search" resultType="com.qiuwanchi.seo.dto.SubProjectDto">
        SELECT * FROM (


        SELECT
        s.id,
        s.number,
        s.name,
        s.describe_msg AS describeMsg,
        s.attachment_id AS attachmentId,
        s.sort,
        s.title,
        s.keywords,
        s.description,
        s.alt,
        s.banner_id AS bannerId,
        s.click_url AS clickUrl,
        s.create_by AS createBy,
        s.create_time AS createTime,
        s.update_by AS updateBy,
        s.update_time AS updateTime,
        a.filename AS fileName,
        a.filesize AS fileSize,
        a.filetype AS fileType,
        a.filepath AS filePath,
        a.file_id AS fileId,
        m.code AS firstCategory,
        p.code AS secondCategory,
        "2" AS caseType
        FROM sub_project s JOIN project p ON s.project_id=p.id
        JOIN module m ON p.module_id=m.id
        LEFT JOIN system_attachment a ON s.attachment_id=a.id
        WHERE m.belong='ServiceCase' AND s.keywords like "%${keyword}%"

        UNION ALL

        SELECT
        p.id,
        p.number,
        p.name,
        p.describe_msg AS describeMsg,
        p.attachment_id AS attachmentId,
        p.sort,
        p.title,
        p.keywords,
        p.description,
        p.alt,
        p.banner_id AS bannerId,
        p.click_url AS clickUrl,
        p.create_by AS createBy,
        p.create_time AS createTime,
        p.update_by AS updateBy,
        p.update_time AS updateTime,
        a.filename AS fileName,
        a.filesize AS fileSize,
        a.filetype AS fileType,
        a.filepath AS filePath,
        a.file_id AS fileId,
        m.code AS firstCategory,
        "" AS secondCategory,
        "3" AS caseType

        FROM  project p JOIN module m ON p.module_id=m.id
        LEFT JOIN system_attachment a ON p.attachment_id=a.id
        WHERE m.belong='SolutionCase'  AND p.keywords like "%${keyword}%"
        ) t ORDER BY t.updateTime DESC
    </select>



    <select id="searchAll" resultType="com.qiuwanchi.seo.dto.SubProjectDto">
        SELECT * FROM (

        SELECT
        p.id,
        p.number,
        p.name,
        p.describe_msg AS describeMsg,
        p.attachment_id AS attachmentId,
        p.sort,
        p.title,
        p.keywords,
        p.description,
        p.alt,
        p.banner_id AS bannerId,
        p.click_url AS clickUrl,
        p.create_by AS createBy,
        p.create_time AS createTime,
        p.update_by AS updateBy,
        p.update_time AS updateTime,
        a.filename AS fileName,
        a.filesize AS fileSize,
        a.filetype AS fileType,
        a.filepath AS filePath,
        a.file_id AS fileId,
        m.code AS firstCategory,
        "" AS secondCategory,
        "1" AS caseType

        FROM  project p JOIN module m ON p.module_id=m.id
        LEFT JOIN system_attachment a ON p.attachment_id=a.id
        WHERE m.belong='News'  AND p.keywords like "%${keyword}%"

        UNION ALL

        SELECT
        s.id,
        s.number,
        s.name,
        s.describe_msg AS describeMsg,
        s.attachment_id AS attachmentId,
        s.sort,
        s.title,
        s.keywords,
        s.description,
        s.alt,
        s.banner_id AS bannerId,
        s.click_url AS clickUrl,
        s.create_by AS createBy,
        s.create_time AS createTime,
        s.update_by AS updateBy,
        s.update_time AS updateTime,
        a.filename AS fileName,
        a.filesize AS fileSize,
        a.filetype AS fileType,
        a.filepath AS filePath,
        a.file_id AS fileId,
        m.code AS firstCategory,
        p.code AS secondCategory,
        "2" AS caseType
        FROM sub_project s JOIN project p ON s.project_id=p.id
        JOIN module m ON p.module_id=m.id
        LEFT JOIN system_attachment a ON s.attachment_id=a.id
        WHERE m.belong='ServiceCase' AND s.keywords like "%${keyword}%"

        UNION ALL

        SELECT
        p.id,
        p.number,
        p.name,
        p.describe_msg AS describeMsg,
        p.attachment_id AS attachmentId,
        p.sort,
        p.title,
        p.keywords,
        p.description,
        p.alt,
        p.banner_id AS bannerId,
        p.click_url AS clickUrl,
        p.create_by AS createBy,
        p.create_time AS createTime,
        p.update_by AS updateBy,
        p.update_time AS updateTime,
        a.filename AS fileName,
        a.filesize AS fileSize,
        a.filetype AS fileType,
        a.filepath AS filePath,
        a.file_id AS fileId,
        m.code AS firstCategory,
        "" AS secondCategory,
        "3" AS caseType

        FROM  project p JOIN module m ON p.module_id=m.id
        LEFT JOIN system_attachment a ON p.attachment_id=a.id
        WHERE m.belong='SolutionCase'  AND p.keywords like "%${keyword}%"
        ) t ORDER BY t.updateTime DESC
    </select>
</mapper>